<!DOCTYPE html>
<html>
  <head>
      <meta charset='utf-8' />
      <title></title>
      <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
      <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.41.0/mapbox-gl.js'></script>
      <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.41.0/mapbox-gl.css' rel='stylesheet' />
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
      <style>
          body {
            margin:0;
            padding:0;
          }
          #map {
            position:absolute;
            top:0;
            bottom:0;
            width:100%;
          }
          #menu {
          background: #444;
          position: absolute;
          z-index: 1;
          top: 10px;
          right: 10px;
          }
      </style>
  </head>
  <body>
    <div id="menu">
      <input type="text" id="keyword"></input>
      <button id="search">Search</button>
    </div>
    <div id='map'></div>
    <input type="text"><input>
    <script>
      mapboxgl.accessToken = 'pk.eyJ1IjoiMTdraWthayIsImEiOiJjajFiNGV6OXowYThmMndxdXkza2cwdjkzIn0.oWzYH-kOaKw1mT5ZEZoKGg';
      var map = new mapboxgl.Map({
          container: 'map', // container id
          style: 'mapbox://styles/mapbox/dark-v9', // stylesheet location
          center: [-30.50, 40], // starting position [lng, lat]
          zoom: 2 // starting zoom
      });
      $("#search").click( () => {
        let keyword = $("#keyword").val();
        keyword = keyword.replace(" ", "");
        $.get(`https://app.ticketmaster.com/discovery/v2/events.json?apikey=cBbUTH4FAtjJuMHrJuKFFs5s2rYa8hgt&keyword=${keyword}`, (data) => {
            console.log(data);
            let markers = [];
            for(let i = 0; i < data._embedded.events.length; i++){
              for(let x = 0; x < data._embedded.events[i]._embedded.venues.length; x++) {
                let long = data._embedded.events[i]._embedded.venues[x].location.longitude;
                let lat = data._embedded.events[i]._embedded.venues[x].location.latitude;
                let marker = {
                    "type": "Feature",
                    "properties": {
                      "description": `<strong>${data._embedded.events[i].name}</strong><p>${data._embedded.events[i]._embedded.venues[x].name}</p> <p>${data._embedded.events[i]._embedded.venues[x].city.name}, ${data._embedded.events[i]._embedded.venues[x].country.name}</p><p>${data._embedded.events[i].dates.start.localDate}</p><a href="detailed.html#${data._embedded.events[i].id}">More Details</a>`
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [long, lat]
                    }
                  };
                markers.push(marker);
                };
              }
                map.addLayer({
                    "id": "points",
                    "type": "symbol",
                    "source": {
                        "type": "geojson",
                        "data": {
                            "type": "FeatureCollection",
                            "features": markers,
                            "properties": {
                              "title": "Event",
                              "icon": "circle-15"
                            }
                        }
                    },
                    "layout": {
                        "icon-image": "circle-15",
                        "icon-size": 1
                    }
                });
                var popup = new mapboxgl.Popup({
                    closeButton: true,
                    closeOnClick: false
                });
                map.on('click', 'points', function(e) {
                    // Change the cursor style as a UI indicator.
                    map.getCanvas().style.cursor = 'pointer';

                    // Populate the popup and set its coordinates
                    // based on the feature found.
                    popup.setLngLat(e.features[0].geometry.coordinates)
                        .setHTML(e.features[0].properties.description)
                        .addTo(map);
                });

                map.on('mouseleave', 'points', function() {
                    map.getCanvas().style.cursor = '';
                });
              console.log(markers);
          });
        });
    </script>

  </body>
</html>
